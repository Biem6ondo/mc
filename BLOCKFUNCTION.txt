-- Crafting Table

local TweenService = game:GetService("TweenService")

local folder = "TexturePack"
local fileName = "CraftingView.png"
local fullPath = folder .. "/" .. fileName
local url = "https://i.postimg.cc/7hYByBrt/Photoroom-20250528-154024.png"

if not isfolder(folder) then makefolder(folder) end
if not isfile(fullPath) then writefile(fullPath, game:HttpGet(url)) end

local guiFolder = Instance.new("Folder", game.CoreGui)
guiFolder.Name = "Crafting_Table"

local screen1 = Instance.new("ScreenGui", guiFolder)
screen1.ScreenInsets = Enum.ScreenInsets.None
screen1.DisplayOrder = 7
screen1.Name = "Open"

local screen2 = Instance.new("ScreenGui", guiFolder)
screen2.DisplayOrder = 8

local background = Instance.new("ImageButton", screen1)
background.BackgroundColor3 = Color3.new(0, 0, 0)
background.Size = UDim2.new(1, 0, 1, 0)
background.BackgroundTransparency = 1
background.AutoButtonColor = false

local content = Instance.new("ImageLabel", screen2)
content.Size = UDim2.new(1, 0, 1, 0)
content.Position = UDim2.new(0, 0, 1, 0)
content.BackgroundTransparency = 1
content.Image = getcustomasset(fullPath)
content.ScaleType = Enum.ScaleType.Fit

local closeBtn = Instance.new("ImageButton", content)
closeBtn.Size = UDim2.new(0, 100, 0, 100)
closeBtn.Position = UDim2.new(0.7, 0, 0, 0)
closeBtn.BackgroundTransparency = 1

local tweenUp = TweenService:Create(content, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
    Position = UDim2.new(0, 0, 0, 0)
})
local fadeIn = TweenService:Create(background, TweenInfo.new(0.6), {
    BackgroundTransparency = 0.5
})

local tweenDown = TweenService:Create(content, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
    Position = UDim2.new(0, 0, 1, 0)
})
local fadeOut = TweenService:Create(background, TweenInfo.new(0.6), {
    BackgroundTransparency = 1
})

screen1.Enabled = false
screen2.Enabled = false

screen1:GetPropertyChangedSignal("Enabled"):Connect(function()
    if screen1.Enabled then
        content.Position = UDim2.new(0, 0, 1, 0)
        background.BackgroundTransparency = 1
        screen2.Enabled = true
        tweenUp:Play()
        fadeIn:Play()
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    tweenDown:Play()
    fadeOut:Play()
    tweenDown.Completed:Wait()
    screen1.Enabled = false
    screen2.Enabled = false
game.CoreGui.RobloxGui.Enabled = true
end)

screen1.Enabled = true

local backpack = Instance.new("Frame", content)
backpack.Position = UDim2.new(0.492, 0, 0.52, 0)
backpack.Size = UDim2.new(0.285, 0, 0.22, 0)
backpack.BackgroundTransparency = 1

local uigrid = Instance.new("UIGridLayout", backpack)
uigrid.CellSize = UDim2.new(0, 30, 0, 30)
uigrid.CellPadding = UDim2.new(0, 7, 0, 7)

local function createItem(img, name)
local i = Instance.new("ImageButton", backpack)
i.Image = img
i.Name = name
i.BackgroundTransparency = 1
i.BackgroundColor3 = Color3.new(1, 0, 0) -- Test bruh
end

for _, item in ipairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
if item:IsA("Tool") then
createItem(item.TextureId, item.Name)
end
end
    screen1.Enabled = false
    screen2.Enabled = false

local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local minecraft = workspace:FindFirstChild("Minecraft")
if not minecraft then return end
print("Module: Block Function Loaded!")

-- Leaf !

local offsets = {
    Vector3.new(4, 0, 0),
    Vector3.new(-4, 0, 0),
    Vector3.new(0, 4, 0),
    Vector3.new(0, -4, 0),
    Vector3.new(0, 0, 4),
    Vector3.new(0, 0, -4)
}

local function getOrCreateFolder(name)
    local f = minecraft:FindFirstChild(name)
    if not f then
        f = Instance.new("Folder")
        f.Name = name
        f.Parent = minecraft
    end
    return f
end

local folders = {
    Leaf = getOrCreateFolder("Leaf_Folder"),
    White_Glass = getOrCreateFolder("Glass_Folder"),
    Barrier = getOrCreateFolder("Barrier_Folder")
}

local function getNearbyParts(position, radius)
    local region = Region3.new(position - Vector3.new(radius, radius, radius), position + Vector3.new(radius, radius, radius)):ExpandToGrid(4)
    return workspace:FindPartsInRegion3(region, nil, math.huge)
end

local function revealNearbyParts(centerPart)
    for _, offset in ipairs(offsets) do
        local targetPos = centerPart.Position + offset
        for _, part in ipairs(getNearbyParts(targetPos, 2)) do
            if part:IsA("BasePart") and part ~= centerPart then
                if (part.Position - targetPos).Magnitude <= 0.1 then
                    part.Transparency = 0
                    for _, decal in ipairs(part:GetDescendants()) do
                        if decal:IsA("Decal") then
                            decal.Transparency = 0
                        end
                    end
                end
            end
        end
    end
end

local function processTransparentPart(part)
    local folder = folders[part.Name]
    if not folder then return end

    part.Parent = folder
    part.Transparency = 1

    for _, d in ipairs(part:GetDescendants()) do
        if d:IsA("Decal") then
            d.Transparency = 0
        end
    end

    part.AncestryChanged:Connect(function(_, parent)
        if not parent then
            return
        end
        part.Transparency = 1
    end)

    revealNearbyParts(part)
end

minecraft.ChildAdded:Connect(function(child)
    task.wait()
    if child:IsA("BasePart") and folders[child.Name] then
        processTransparentPart(child)
    elseif child:IsA("Model") then
        child.ChildAdded:Connect(function(grandchild)
            if grandchild:IsA("BasePart") and folders[grandchild.Name] then
                processTransparentPart(grandchild)
            end
        end)
    end
end)

for _, part in ipairs(minecraft:GetDescendants()) do
    if part:IsA("BasePart") and folders[part.Name] then
        processTransparentPart(part)
    end
end

-- Sand

local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local function getGroundInfo(part, rayParams)
	local ray = workspace:Raycast(part.Position, Vector3.new(0, -500, 0), rayParams)
	if ray and ray.Instance then
		return ray.Instance, ray.Position.Y + ray.Instance.Size.Y / 4 + part.Size.Y / 4
	else
		return nil, -500
	end
end

local function addClickDetector(part)
	if not part:FindFirstChildOfClass("ClickDetector") then
		local cd = Instance.new("ClickDetector", part)
		cd.MouseClick:Connect(function()
			part:Destroy()
		end)
	end
end

local function tweenDrop(part)
	addClickDetector(part)

	local rayParams = RaycastParams.new()
	rayParams.FilterDescendantsInstances = {part}
	rayParams.FilterType = Enum.RaycastFilterType.Blacklist

	local tween
	local function startTween()
		local hit, targetY = getGroundInfo(part, rayParams)
		local distance = part.Position.Y - targetY

		if distance > 0 then
			part.CanCollide = false -- Tạm thời vô hiệu va chạm khi rơi

			local tweenInfo = TweenInfo.new(distance / 30, Enum.EasingStyle.Linear)
			local goal = {Position = Vector3.new(part.Position.X, targetY, part.Position.Z)}
			tween = TweenService:Create(part, tweenInfo, goal)
			tween:Play()
		end
	end

	startTween()

	local conn
	conn = RunService.Heartbeat:Connect(function()
		if not part or not part.Parent then
			conn:Disconnect()
			return
		end

		local hit, targetY = getGroundInfo(part, rayParams)
		local dist = part.Position.Y - targetY

		if dist <= 0.01 then
			if tween then tween:Cancel() end
			part.Position = Vector3.new(part.Position.X, targetY, part.Position.Z)
			part.CanCollide = true

			if hit and hit:IsA("BasePart") then
				return
			else
				startTween()
			end
		elseif not tween or tween.PlaybackState ~= Enum.PlaybackState.Playing then
			startTween()
		end
	end)
end

minecraft.ChildAdded:Connect(function(child)
	task.wait()
	if child:IsA("BasePart") and child.Name == "Sand" then
		tweenDrop(child)
	end
end)

for _, part in ipairs(minecraft:GetDescendants()) do
	if part:IsA("BasePart") and part.Name == "Sand" then
		tweenDrop(part)
	end
end

-- Dirt Grass
-- Glass
-- Glowstone

minecraft.ChildAdded:Connect(function(glow)
task.wait()
if glow:IsA("BasePart") and glow.Name == "Glowstone" then
local light = Instance.new("PointLight")
light.Brightness = 2
light.Range = 18
light.Parent = glow
end
end)

local lighting = game:GetService("Lighting")

task.spawn(function() 
while true do
	task.wait(1)
lighting.Brightness = 1
	local time = lighting.ClockTime

	if time >= 6 and time <= 18 then
		lighting.FogColor = Color3.new(1, 1, 1)
lighting.OutdoorAmbient = Color3.fromRGB(200, 200, 200)
	else
		lighting.FogColor = Color3.new(0, 0, 0)
lighting.OutdoorAmbient = Color3.new(0, 0, 0)
	end
end
end)

-- Test

local Tool = Instance.new("Tool", game.Players.LocalPlayer.Backpack)
Tool.RequiresHandle = false
Tool.Name = "Test_id:1_Item"

local Player = game.Players.LocalPlayer
local Mouse = Player:GetMouse()

local textureFolder = "TexturePack"
local farmlandName = "FarmlandDry.png"
local dirtName = "Dirt_Face1.png"
local farmlandPath = textureFolder .. "/" .. farmlandName
local dirtPath = textureFolder .. "/" .. dirtName
local farmlandURL = "https://static.wikia.nocookie.net/minecraft_gamepedia/images/6/60/Farmland_%28dry_texture%29_JE2_BE2.png/revision/latest?cb=20201006055318"

if not isfolder(textureFolder) then
    makefolder(textureFolder)
end

if not isfile(farmlandPath) then
    writefile(farmlandPath, game:HttpGet(farmlandURL))
end

local faces = {
    Top = Enum.NormalId.Top,
    Bottom = Enum.NormalId.Bottom,
    Left = Enum.NormalId.Left,
    Right = Enum.NormalId.Right,
    Front = Enum.NormalId.Front,
    Back = Enum.NormalId.Back,
}

local function onActivate()
    local target = Mouse.Target
    if target and target:IsA("BasePart") and (target.Name == "Grass" or target.Name == "Dirt") then
        target.Size = Vector3.new(4, 3.7, 4)
target.Position = target.Position - Vector3.new(0, 0.15, 0)
target.Name = "Test_Block_Changed_1"
        for _, d in ipairs(target:GetChildren()) do
            if d:IsA("Decal") then
                d:Destroy()
            end
        end
        local decalTop = Instance.new("Decal")
        decalTop.Face = faces.Top
        decalTop.Texture = getcustomasset(farmlandPath)
        decalTop.Parent = target
        for faceName, faceEnum in pairs(faces) do
            if faceEnum ~= Enum.NormalId.Top then
                local decal = Instance.new("Decal")
                decal.Face = faceEnum
                decal.Texture = getcustomasset(dirtPath)
                decal.Parent = target
            end
        end
    end
end

Tool.Activated:Connect(onActivate)

-- Barrier

local folderPath = "TexturePack"
local fileName = "Barrier.png"
local fullPath = folderPath .. "/" .. fileName

if not isfolder(folderPath) then
    makefolder(folderPath)
end

if not isfile(fullPath) then
    writefile(fullPath, game:HttpGet("https://static.wikia.nocookie.net/minecraft/images/8/8d/BarrierNew.png/revision/latest?cb=20190830230156"))
end

local minecraft = workspace:FindFirstChild("Minecraft")
if not minecraft then return end

local barrierFolder = Instance.new("Folder")
barrierFolder.Name = "Barrier_Folder"
barrierFolder.Parent = minecraft

local function addBillboard(part)
    if not part:IsA("BasePart") then return end
    if part:FindFirstChild("BarrierGui") then return end

    part.Transparency = 1

    local billboard = Instance.new("BillboardGui")
    billboard.Name = "BarrierGui"
    billboard.Adornee = part
    billboard.Size = UDim2.new(4, 0, 4, 0)
    billboard.AlwaysOnTop = false
    billboard.Enabled = false
    billboard.Parent = part

    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1, 0, 1, 0)
    img.BackgroundTransparency = 1
    img.Image = getcustomasset(fullPath)
    img.Name = "Barrier"
    img.Parent = billboard

    task.defer(function()
        part.Parent = barrierFolder
    end)
end

for _, part in pairs(minecraft:GetDescendants()) do
    if part:IsA("BasePart") and part.Name == "Barrier" then
        addBillboard(part)
    end
end

minecraft.DescendantAdded:Connect(function(desc)
    if desc:IsA("BasePart") and desc.Name == "Barrier" then
        addBillboard(desc)
    end
end)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local backpack = player:WaitForChild("Backpack")

local folderPath = workspace:WaitForChild("Minecraft"):WaitForChild("Barrier_Folder")

RunService.RenderStepped:Connect(function()
    local hasBarrierTool = backpack:FindFirstChild("Barrier_Item") ~= nil

    for _, descendant in pairs(folderPath:GetDescendants()) do
        if descendant:IsA("BillboardGui") then
            descendant.Enabled = not hasBarrierTool
        end
    end
end)

-- Barrier part 2
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

RunService.Heartbeat:Connect(function()
		for _, t in ipairs(minecraft:WaitForChild("Barrier_Folder"):GetChildren()) do
			task.wait()
			if t:IsA("BasePart") and t.Name == "Barrier" then
				t.Transparency = 1

				local rayOrigin = t.Position
				local rayDirection = Vector3.new(0, -4, 0)
				local rayParams = RaycastParams.new()
				rayParams.FilterDescendantsInstances = {minecraft:WaitForChild("Barrier_Folder")}
				rayParams.FilterType = Enum.RaycastFilterType.Blacklist

				local result = workspace:Raycast(rayOrigin, rayDirection, rayParams)

				if result and result.Instance then
					local partBelow = result.Instance
					if partBelow:IsA("BasePart") then
						partBelow.Transparency = 0
						
						for _, decal in ipairs(partBelow:GetDescendants()) do
							if decal:IsA("Decal") then
								decal.Transparency = 0
							end
						end
					end
				end
			end
		end
end)

-- Crafting_Func

local function setupClickDetector(part)
    if part:IsA("BasePart") and part.Name == "Crafting_Table" then
        if not part:FindFirstChildOfClass("ClickDetector") then
            local click = Instance.new("ClickDetector")
            click.Parent = part
            click.MouseClick:Connect(function(player)
                print("Clicked:", part.Name)
    screen1.Enabled = true
    screen2.Enabled = true
game.CoreGui.RobloxGui.Enabled = false
            end)
        end
    end
end

for _, child in ipairs(minecraft:GetChildren()) do
    setupClickDetector(child)
end

minecraft.ChildAdded:Connect(function(child)
    setupClickDetector(child)
end)

-- More Again
task.spawn(function()
while wait(0.1) do
for _, v in ipairs(workspace.Minecraft.Leaf_Folder:GetChildren()) do
task.wait()
v.Transparency = 1
end
for _, v in ipairs(workspace.Minecraft.Glass_Folder:GetChildren()) do
task.wait()
v.Transparency = 0.7
v.Color = Color3.new(1, 1, 1)
end
end
end)